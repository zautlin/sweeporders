# Simulated Trades Summary

**Generated:** 2026-01-11  
**Dataset:** DRR (OrderbookID 110621)  
**Date:** 2024-09-05  
**File:** `data/processed/2024-09-05/110621/cp_trades_simulation.csv`

---

## Overview

This document summarizes the simulated trades generated by the refactored sweep matching simulator. The simulator now generates **full trade rows directly at match time** (2 rows per match), eliminating the intermediate `match_details` structure.

---

## Summary Statistics

| Metric | Value |
|--------|-------|
| **Total Matches** | 1,548 |
| **Total Trade Rows** | 3,096 (1,548 √ó 2) |
| **File Size** | 3,097 rows (including header) |
| **Unique Sweep Orders** | 841 sweep orders |
| **Unique Order IDs** | 1,876 total orders |
| **Total Quantity Traded** | 1,225,874 shares |
| **Average Quantity per Row** | 395.83 shares |
| **Min Quantity** | 1 share |
| **Max Quantity** | 10,652 shares |

---

## Trade Row Structure

Each match generates **2 trade rows**:

### Row 1: Aggressor (Sweep Order)
- `orderid`: Sweep order ID
- `passiveaggressive`: **1** (aggressor)
- `side`: Sweep order side

### Row 2: Passive (Incoming Order)
- `orderid`: Incoming order ID  
- `passiveaggressive`: **0** (passive)
- `side`: Incoming order side (opposite of sweep)

Both rows share the same:
- `matchgroupid`: Links the two rows of each match
- `tradetime`: When the match occurred
- `tradeprice`: Execution price (NBBO midpoint)
- `quantity`: Matched quantity
- NBBO bid and offer snapshots

---

## Schema (17 Columns)

All columns contain essential trade execution data. No derived or analytical fields are stored.

| # | Column | Description |
|---|--------|-------------|
| 1 | `EXCHANGE` | Exchange identifier (3 = Centre Point) |
| 2 | `sequence` | Sequential row number |
| 3 | `tradedate` | Trade date (YYYY-MM-DD) |
| 4 | `tradetime` | Trade timestamp (nanoseconds) |
| 5 | `securitycode` | Security code / OrderbookID |
| 6 | `orderid` | Order ID (sweep or incoming) |
| 7 | `dealsource` | Deal source code (99 = simulated) |
| 8 | `exchangeinfo` | Exchange info (empty for simulated) |
| 9 | `matchgroupid` | Unique match identifier |
| 10 | `nationalbidpricesnapshot` | NBBO bid at match time |
| 11 | `nationalofferpricesnapshot` | NBBO offer at match time |
| 12 | `tradeprice` | Execution price (midpoint) |
| 13 | `quantity` | Matched quantity |
| 14 | `side` | Order side (1=buy, 2=sell) |
| 15 | `participantid` | Participant ID |
| 16 | `passiveaggressive` | Role (1=aggressor, 0=passive) |
| 17 | `row_num` | Global row number |

---

## Retrieving Analytical Data

Timestamp and duration data can be derived by joining with order data:

### Get Sweep Order Timestamp
```python
# Load data
trades = pd.read_csv('cp_trades_simulation.csv')
orders = pd.read_csv('orders_before_matching.csv')

# Filter aggressor rows (sweep orders)
aggressor = trades[trades['passiveaggressive'] == 1]

# Join to get sweep timestamp
aggressor = aggressor.merge(
    orders[['orderid', 'timestamp']], 
    on='orderid',
    how='left'
)
# aggressor['timestamp'] is the sweep order timestamp
```

### Calculate Match Duration
```python
# Duration from sweep placement to match
aggressor['sweeptomatchduration'] = aggressor['tradetime'] - aggressor['timestamp']
aggressor['duration_sec'] = aggressor['sweeptomatchduration'] / 1e9

# Statistics
print(f"Average duration: {aggressor['duration_sec'].mean():.2f} seconds")
print(f"Min duration: {aggressor['duration_sec'].min():.2f} seconds")
print(f"Max duration: {aggressor['duration_sec'].max():.2f} seconds")
```

### Helper Function
```python
def enrich_trades_with_timestamps(trades_df, orders_df):
    """Add sweep timestamp and duration to aggressor trades."""
    aggressor = trades_df[trades_df['passiveaggressive'] == 1].copy()
    
    aggressor = aggressor.merge(
        orders_df[['orderid', 'timestamp']],
        on='orderid',
        how='left',
        suffixes=('', '_sweep')
    )
    
    aggressor['sweepordertimestamp'] = aggressor['timestamp']
    aggressor['sweeptomatchduration'] = aggressor['tradetime'] - aggressor['timestamp']
    
    return aggressor
```

---

## Data Distribution

### Aggressor vs Passive
| Role | Rows | Total Quantity |
|------|------|----------------|
| Aggressor (Sweep) | 1,548 | 612,937 shares |
| Passive (Incoming) | 1,548 | 612,937 shares |

### Side Distribution
| Side | Rows | Total Quantity |
|------|------|----------------|
| Side 1 (Buy) | 1,548 | 612,937 shares |
| Side 2 (Sell) | 1,548 | 612,937 shares |

### Price Distribution
| Price | Trade Rows |
|-------|-----------|
| 3335 | 3,036 (98.1%) |
| 3340 | 60 (1.9%) |

**Note:** Prices are calculated as NBBO midpoint at match time.

---

## Timing Analysis

### Duration Calculation Example
Time from when sweep order was placed to when it matched can be calculated by joining with orders:

```python
# Example from DRR 2024-09-05 dataset
trades = pd.read_csv('cp_trades_simulation.csv')
orders = pd.read_csv('orders_before_matching.csv')

# Get aggressor rows and join with orders
aggressor = trades[trades['passiveaggressive'] == 1]
aggressor = aggressor.merge(orders[['orderid', 'timestamp']], on='orderid')

# Calculate duration
aggressor['duration_ns'] = aggressor['tradetime'] - aggressor['timestamp']
aggressor['duration_sec'] = aggressor['duration_ns'] / 1e9

# Statistics
print(aggressor['duration_sec'].describe())
```

**Results from this dataset:**

| Statistic | Value |
|-----------|-------|
| **Minimum** | 0.00 seconds (immediate match) |
| **Maximum** | 1,008.50 seconds (~16.8 minutes) |
| **Average** | 57.03 seconds |

---

## Sample Data

First 4 trades (2 matches):

### Match 1 (matchgroupid: 7904794000999000001)
```
Row 1 (Aggressor):
  orderid: 7904794000124134556 (sweep)
  passiveaggressive: 1
  side: 2 (sell)
  quantity: 2
  tradeprice: 3335
  tradetime: 1725494538064829640

Row 2 (Passive):
  orderid: 7904794000124135002 (incoming)
  passiveaggressive: 0
  side: 1 (buy)
  quantity: 2
  tradeprice: 3335
  tradetime: 1725494538064829640 (same as row 1)
```

### Match 2 (matchgroupid: 7904794000999000002)
```
Row 3 (Aggressor):
  orderid: 7904794000124134556 (sweep, same as match 1)
  passiveaggressive: 1
  side: 2 (sell)
  quantity: 268
  tradeprice: 3335
  tradetime: 1725494538076428033

Row 4 (Passive):
  orderid: 7904794000124135018 (incoming, different)
  passiveaggressive: 0
  side: 1 (buy)
  quantity: 268
  tradeprice: 3335
  tradetime: 1725494538076428033 (same as row 3)
```

**Note:** Same sweep order can match multiple times (rows 1 and 3 show sweep order 7904794000124134556 matching twice).

---

## Key Design Features

### 1. Direct Generation
- Trade rows generated **directly at match time**
- No intermediate transformation step
- Single NBBO lookup per match (not per row)

### 2. Two-Row Per Match
- Each match creates exactly 2 rows
- Rows linked by `matchgroupid`
- One aggressor (sweep), one passive (incoming)

### 3. NBBO Integration
- NBBO bid and offer snapshots captured at match time
- Trade price calculated as midpoint: `(bid + offer) / 2`
- Values stored in `nationalbidpricesnapshot` and `nationalofferpricesnapshot`

### 4. Essential Data Only
- Only core trade execution data stored (17 columns)
- No derived or analytical fields in output
- Timestamps and durations can be calculated by joining with orders
- Keeps files smaller and more focused

### 5. Column Naming Convention
- Lowercase, no underscores (follows real trades format)
- Example: `nationalbidpricesnapshot` not `national_bid_price_snapshot`

---

## Validation Results

### Pipeline Test: DRR 2024-09-05
- ‚úÖ Pipeline completed successfully
- ‚úÖ 1,548 matches generated
- ‚úÖ 3,096 trade rows created (1,548 √ó 2)
- ‚úÖ Exactly 17 columns (core trade data only)
- ‚úÖ No `match_details.csv` created (deprecated)
- ‚úÖ Perfect pairing: every match has exactly 2 rows
- ‚úÖ Aggressor/passive counts match (1,548 each)
- ‚úÖ Quantity consistency: aggressor qty = passive qty

### Data Integrity Checks
- ‚úÖ Unique `matchgroupid` count: 1,548 (matches trade count)
- ‚úÖ Each `matchgroupid` appears exactly twice
- ‚úÖ Total quantity balanced across sides
- ‚úÖ All timestamps in valid nanosecond format
- ‚úÖ Prices match NBBO midpoint calculations

---

## Performance Improvements

### Before Refactoring
1. Generate minimal match records (6 fields)
2. Store in `match_details` DataFrame
3. Transform to trade rows via `generate_simulated_trades()`
4. Duplicate NBBO lookups (once per match + once per trade)

### After Refactoring
1. Generate full trade rows directly (21 fields)
2. Return as `simulated_trades` DataFrame
3. Single NBBO lookup per match
4. ~125 lines of code deleted

**Expected Performance Gain:** ~24% reduction in execution time

---

## File Locations

### Primary Output
```
data/processed/2024-09-05/110621/cp_trades_simulation.csv
```
- 3,097 rows (3,096 data + 1 header)
- 21 columns
- Uncompressed CSV

### Related Files
```
data/outputs/2024-09-05/110621/
‚îú‚îÄ‚îÄ simulation_order_summary.csv      # Per-order summary
‚îú‚îÄ‚îÄ orders_with_simulated_metrics.csv # Orders with metrics
‚îî‚îÄ‚îÄ trade_level_comparison.csv        # Real vs simulated
```

---

## Usage Notes

### For Analysis
1. **Filtering by role:**
   - Aggressor: `passiveaggressive == 1`
   - Passive: `passiveaggressive == 0`

2. **Grouping by match:**
   - Use `matchgroupid` to link rows
   - Each match = 2 rows with same `matchgroupid`

3. **Calculating metrics:**
   - Use aggressor rows for sweep order metrics
   - Use passive rows for incoming order metrics
   - Both rows have identical quantity/price/time

4. **Duration analysis:**
   - Join with `orders_before_matching.csv` to get sweep timestamp
   - Calculate: `duration_ns = tradetime - sweep_timestamp`
   - Convert to seconds: `duration_ns / 1e9`
   - See "Retrieving Analytical Data" section for code examples

### For Comparison
Compare with real trades:
```
data/processed/2024-09-05/110621/cp_trades_matched.csv.gz
```

Use `trade_level_comparison.csv` for pre-computed comparisons.

---

## Breaking Changes from Previous Version

### ‚ùå Removed (v2.0)
- 4 analytical columns: `sweepordertimestamp`, `incomingordertimestamp`, `nbbotimestamp`, `sweeptomatchduration`
- These can be derived by joining with orders data (see "Retrieving Analytical Data" section)

### ‚ùå Removed (v1.0)
- `match_details` DataFrame (deprecated)
- `simulation_match_details.csv` file
- `generate_simulated_trades()` function
- Intermediate transformation step

### ‚úÖ Current Schema (v2.0)
- `simulated_trades` DataFrame with 17 columns (core trade data only)
- Direct generation at match time
- Performance optimizations
- Essential fields only (no derived data)

### üîÑ Changed (v2.0)
- Schema reduced from 21 to 17 columns (removed analytical columns)
- Timestamps and duration now calculated on-demand via joins

### üîÑ Changed (v1.0)
- Each match generates 2 rows instead of 1 (aggressor + passive)
- `passiveaggressive` column indicates role
- Return structure: `sim_results['simulated_trades']` not `sim_results['match_details']`

---

## Technical Details

### Match Group ID Generation
```python
base_matchgroupid = 7904794000999000001
matchgroupid = base_matchgroupid + match_counter
```
- Starts at 7904794000999000001
- Increments by 1 per match
- Range: 7904794000999000001 to 7904794000999001548

### NBBO Lookup Strategy
```python
nbbo_bid, nbbo_offer, nbbo_timestamp = _get_nbbo_at_timestamp(
    nbbo_sorted, 
    order_timestamp, 
    orderbookid
)
midpoint = _calculate_midpoint(nbbo_bid, nbbo_offer)
```
- Single lookup per match (not per row)
- Finds NBBO at or before match time
- Fallback to 0 if no NBBO available

### Duration Calculation (On-Demand)
Duration must be calculated by joining with orders:
```python
# Join aggressor trades with orders to get sweep timestamp
aggressor = trades[trades['passiveaggressive'] == 1]
aggressor = aggressor.merge(orders[['orderid', 'timestamp']], on='orderid')

# Calculate duration
sweeptomatchduration = aggressor['tradetime'] - aggressor['timestamp']
```
- Both timestamps in nanoseconds since epoch
- Positive value = time elapsed
- Can be 0 for immediate matches
- See "Retrieving Analytical Data" section for complete examples

---

## Future Enhancements

Potential additions to schema or functionality:

1. **Price Impact Metrics**
   - Track NBBO movement after match
   - Calculate price improvement vs limit price

2. **Queue Position**
   - Estimate queue position at match time
   - Model queue dynamics

3. **Liquidity Metrics**
   - Available liquidity at NBBO
   - Depth beyond best bid/offer

4. **Match Quality Score**
   - Compare to real execution
   - Measure simulation accuracy

---

## References

### Related Documentation
- `README.md` - Pipeline overview
- `src/pipeline/sweep_simulator.py` - Implementation
- `src/config/config.py` - Configuration

### Git History
- Branch: `b4modification`
- Commit: `6beb171`
- Message: "refactor: Generate full trade rows directly at match time"

---

## Contact & Support

For questions about this dataset or the simulation methodology, please refer to:
- Pipeline documentation in repository
- Code comments in `sweep_simulator.py`
- Commit history for implementation details

---

**Document Version:** 2.0  
**Last Updated:** 2026-01-11  
**Schema Version:** 17 columns (analytical columns removed)  
**Pipeline Version:** Post-refactoring (direct generation, essential data only)
